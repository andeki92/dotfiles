name: Benchmark zsh startup time

on:
  pull_request:
    paths:
      - 'config/zsh/**'
      - '.github/workflows/benchmark.yml'
      - 'scripts/benchmark.sh'

jobs:
  benchmark:
    name: Benchmark PR branch
    runs-on: ubuntu-latest
    steps:
      - name: Check out PR branch
        uses: actions/checkout@v4
      
      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh time bc
      
      - name: Set up environment
        run: |
          mkdir -p ~/.config/zsh
      
      - name: Run benchmark
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_DESCRIPTION: ${{ github.event.pull_request.title }}
        run: |
          ./scripts/benchmark.sh --save
      
      - name: Store PR benchmark time
        run: |
          mkdir -p artifacts
          cp /tmp/pr_time.txt artifacts/

      - name: Upload PR benchmark
        uses: actions/upload-artifact@v3
        with:
          name: pr-benchmark
          path: artifacts/pr_time.txt
      
      - name: Commit benchmark results
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add docs/benchmarks.md
          git commit -m "Update benchmarks for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
          git push
  
  benchmark-main:
    name: Benchmark main branch
    runs-on: ubuntu-latest
    steps:
      - name: Check out main branch
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh time bc
      
      - name: Set up environment
        run: |
          mkdir -p ~/.config/zsh
      
      - name: Run benchmark
        run: |
          ./scripts/benchmark.sh
          echo "MAIN_TIME=$(grep 'Average startup time' /tmp/output.txt | awk '{print $4}' | tr -d 's')" >> $GITHUB_ENV
          mkdir -p artifacts
          echo "MAIN_TIME=${MAIN_TIME}" > artifacts/main_time.txt
        
      - name: Upload main branch benchmark
        uses: actions/upload-artifact@v3
        with:
          name: main-benchmark
          path: artifacts/main_time.txt
  
  compare:
    name: Compare benchmarks
    needs: [benchmark, benchmark-main]
    runs-on: ubuntu-latest
    steps:
      - name: Download PR benchmark
        uses: actions/download-artifact@v3
        with:
          name: pr-benchmark
          path: artifacts
      
      - name: Download main benchmark
        uses: actions/download-artifact@v3
        with:
          name: main-benchmark
          path: artifacts
      
      - name: Compare results
        run: |
          PR_TIME=$(cat artifacts/pr_time.txt | grep PR_TIME | cut -d= -f2)
          MAIN_TIME=$(cat artifacts/main_time.txt | grep MAIN_TIME | cut -d= -f2)
          echo "PR branch startup time: ${PR_TIME}s"
          echo "Main branch startup time: ${MAIN_TIME}s"
          
          # Calculate difference
          DIFF=$(echo "scale=3; $MAIN_TIME - $PR_TIME" | bc)
          
          if (( $(echo "$DIFF > 0" | bc -l) )); then
            echo "PR is ${DIFF}s faster than main branch ✅"
          elif (( $(echo "$DIFF < 0" | bc -l) )); then
            DIFF=$(echo "scale=3; $DIFF * -1" | bc)
            echo "PR is ${DIFF}s slower than main branch ❌"
          else
            echo "No significant difference between PR and main branch ⚠️"
          fi 